var picture,sawAlert,shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),form=document.querySelector("form"),inputTitle=document.querySelector("#title"),inputLocation=document.querySelector("#location"),manLocation=document.querySelector("#manual-location"),videoPlayer=document.querySelector("#player"),canvasElement=document.querySelector("#canvas"),btnCapture=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),btnLocation=document.querySelector("#location-btn"),loaderLocation=document.querySelector("#location-loader"),fetchedLocation={lat:0,lng:0},getUrl="https://pwagram-16a15.firebaseio.com/posts.json",postUrl="https://us-central1-pwagram-16a15.cloudfunctions.net/storePostData";function initializeMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=function(o){var a=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return a?new Promise(function(e,t){a.call(navigator,o,e,t)}):Promise.reject(new Error("getUserMedia is not supported!"))}),navigator.mediaDevices.getUserMedia({video:!0}).then(function(e){videoPlayer.srcObject=e,videoPlayer.style.display="block"}).catch(function(e){imagePickerArea.style.display="block"})}function initializeLocation(){"geolocation"in navigator||(btnLocation.style.display="none")}function openCreatePostModal(){createPostArea.style.display="block",initializeMedia(),initializeLocation(),defferedPrompt&&(defferedPrompt.prompt(),defferedPrompt.userChoice.then(function(e){console.log(e.outcome),"dismissed"===e.outcome?console.log("User cancelled installation"):console.log("App added to home screen")}),defferedPrompt=null)}function closeCreatePostModal(){createPostArea.style.display="none",btnCapture.style.display="inline",videoPlayer.style.display="none",imagePickerArea.style.display="none",canvasElement.style.display="none",btnLocation.style.display="inline",loaderLocation.style.display="none",videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()})}function onButtonSaveClick(e){console.log("btn save clicked"),"caches"in window&&caches.open("user-created").then(function(e){e.add("https://httpbin.org/get"),e.add("/src/images/sf-boat.jpg")})}function clearCards(){for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)}function createCard(e){var t=document.createElement("div");t.className="shared-moment-card mdl-card mdl-shadow--2dp",t.style.margin="auto";var o=document.createElement("div");o.className="mdl-card__title",o.style.backgroundImage="url("+e.image+")",o.style.backgroundSize="cover",o.style.height="180px",t.appendChild(o);var a=document.createElement("h2");a.style.color="white",a.className="mdl-card__title-text",a.textContent=e.title,o.appendChild(a);var n=document.createElement("div");n.className="mdl-card__supporting-text",n.textContent=e.location,n.style.textAlign="center",t.appendChild(n),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function sendData(){var e=new FormData,t=(new Date).toISOString();e.append("id",t),e.append("title",inputTitle.value),e.append("location",inputLocation.value),e.append("rawLocationLat",fetchedLocation.lat),e.append("rawLocationLng",fetchedLocation.lng),e.append("file",picture,t+".png"),fetch(postUrl,{method:"POST",body:e}).then(function(e){console.log("Data sent: ",e)})}function createCards(e){clearCards();for(var t=0;t<e.length;t++)createCard(e[t])}function updateUI(e){var t=[];for(var o in e)t.push(e[o]);createCards(t)}btnCapture.addEventListener("click",function(e){canvasElement.style.display="block",videoPlayer.style.display="none",btnCapture.style.display="none",canvasElement.getContext("2d").drawImage(videoPlayer,0,0,canvasElement.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvasElement.width)),videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()}),picture=dataURItoBlob(canvasElement.toDataURL())}),imagePicker.addEventListener("change",function(e){picture=e.target.files[0]}),btnLocation.addEventListener("click",function(e){"geolocation"in navigator&&(btnLocation.style.display="none",loaderLocation.style.display="block",navigator.geolocation.getCurrentPosition(function(e){console.log("getCurrentPosition obtained the position ",e),btnLocation.style.display="inline",loaderLocation.style.display="none",fetchedLocation={lat:e.coords.latitude,lng:0},inputLocation.value="On the moon",manLocation.classList.add("is-focused")},function(e){console.log("Error on getCurrentPosition ",e),btnLocation.style.display="inline",loaderLocation.style.display="none",sawAlert||(alert("Can't fetch location, please use manual input."),sawAlert=!0),fetchedLocation={lat:0,lng:0}},{timeout:7e3}))}),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal),form.addEventListener("submit",function(e){e.preventDefault(),""!==inputTitle.value.trim()&&""!==inputLocation.value.trim()?(closeCreatePostModal(),"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(function(e){var t={id:(new Date).toISOString(),title:inputTitle.value,location:inputLocation.value,picture:picture,rawLocation:fetchedLocation};writeData("sync-posts",t).then(function(){return e.sync.register("sync-new-post")}).then(function(){document.querySelector("#confirmation-toast").MaterialSnackbar.showSnackbar({message:"Post saved for sync!"})}).catch(function(e){console.log("Sync error",e)})}):sendData()):window.alert("Please enter valid data.")});var netDataReceived=!1;fetch(getUrl).then(function(e){return e.json()}).then(function(e){netDataReceived=!0,console.log("From network",e),updateUI(e)}),"indexedDB"in window&&readAllData("posts").then(function(e){netDataReceived||(console.log("From cache idb: ",e),updateUI(e))});